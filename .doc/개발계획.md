## Yorkie Next Flow 개발 계획

### 목표

- **Next.js** 환경에서 **React Flow**를 사용해 **Yorkie(CRDT)** 기반의 실시간 공동 편집 그래프 에디터 구현
- 루트 페이지에서 문서명을 입력 → 동일 문서명으로 접속한 사용자끼리 동시 편집
- 초기 그래프는 비어 있음(nodes/edges 없음), 별도 기본 flow 제공 없음
- UI에 **Add** 버튼을 제공하여 노드를 추가 가능하게 함

### 요구사항 재정리

- **문서 접속**: 루트(`/`)에서 문서명을 입력해 `/doc/[docKey]`로 라우팅
- **문서 키**: 입력값을 그대로 사용하거나 해시 사용 가능. 초안에서는 입력값을 정규화(slug)하여 사용하고, 옵션으로 해시 전략 지원
- **기본 그래프**: 초기값 `{ nodes: [], edges: [] }`
- **노드 추가**: Add 버튼 클릭 시 새 노드 추가(위치/ID 자동 생성)

### 아키텍처 개요

- **페이지 구조**
  - `/`(서버 컴포넌트 + 클라이언트 폼): 문서명 입력 폼, 제출 시 `/doc/[docKey]`로 이동
  - `/doc/[doc]`(클라이언트 컴포넌트): React Flow + Yorkie Provider/DocumentProvider로 공동 편집 캔버스
- **컴포넌트**
  - `DocForm`(client): 문서명 입력, `docKey` 생성, 라우팅
  - `FlowEditor`(client): `@xyflow/react`와 `@yorkie-js/react` 연동, Add 버튼 포함
- **Provider 구성**
  - `YorkieProvider` 상위에서 `apiKey`, `rpcAddr` 주입
  - `DocumentProvider`에 `docKey`와 `initialRoot` 전달

### 의존성

- 런타임: `@yorkie-js/react`, `@xyflow/react`
- 스타일: `@xyflow/react/dist/style.css`(클라이언트 컴포넌트에서 임포트)
- 설치 예시

```bash
npm i @yorkie-js/react @xyflow/react
```

### 환경 변수

- `NEXT_PUBLIC_YORKIE_API_KEY`: Yorkie API Key
- `NEXT_PUBLIC_YORKIE_API_ADDR`: Yorkie RPC 주소(e.g. `https://api.yorkie.dev`, 로컬: `http://localhost:8080`)

### 데이터 모델

- `Graph` 타입
  - `nodes: JSONArray<Node>`
  - `edges: JSONArray<Edge>`
- `initialRoot`: `{ nodes: [], edges: [] }`

### 핵심 기능 상세

- **문서 키 전략(docKey)**
  - 기본: 사용자가 입력한 문서명을 **slugify(lowercase, 공백→하이픈, 특수문자 제거)** 후 그대로 사용
  - 선택: 동일 입력을 해시(SHA-1/MD5 등)하여 `doc-<hash>` 형태 사용(확장 포인트)
- **노드 추가(Add)**
  - 버튼 클릭 → `update` 콜백으로 CRDT에 새 노드 push
  - ID: `n-<timestamp>-<rand>` 혹은 `nanoid`
  - 위치: 최근 추가 위치 기준 오프셋(+40, +40) 또는 간단 랜덤 범위
- **React Flow 이벤트 연동**
  - `onNodesChange`, `onEdgesChange`, `onConnect`를 Yorkie `update`에 매핑
  - 중복 엣지 방지 로직 포함
- **렌더링**
  - `nodes={[...root.nodes].filter(Boolean)}`
  - `edges={[...root.edges].filter(Boolean)}`

### Next.js 고려사항

- **클라이언트 컴포넌트**: `FlowEditor`와 폼은 `'use client'` 필요
- **CSS 로딩**: `@xyflow/react/dist/style.css`는 클라이언트 컴포넌트 상단에서 import
- **동적 라우팅**: `src/app/doc/[doc]/page.tsx`에서 `params.doc`로 `docKey` 수신
- **환경 변수 접근**: 클라이언트에서 `process.env.NEXT_PUBLIC_*`를 읽어 `YorkieProvider`에 전달

### 에러 처리 및 UX

- 환경 변수 미설정 시 가드: 안내 메시지와 설정 가이드 표시
- `loading`/`error` 상태 표시(로딩 스피너, 에러 텍스트)
- 빈 그래프 접근 시 정상 렌더

### 테스트 전략

- **기능 테스트**: 같은 `docKey`로 2개 브라우저 접속 → 노드 추가/이동/연결이 양쪽에서 동기화되는지 확인
- **회귀 테스트**: 새 노드 추가, 삭제, 포지션 이동, 엣지 연결/해제 시 예외 발생 여부 확인

### 작업 순서(로드맵)

1. 의존성 설치 및 환경 변수 템플릿 추가
2. 루트 페이지(`/`)에 문서명 입력 폼 구현 → 제출 시 `/doc/[docKey]`
3. 동적 라우트 `/doc/[doc]` 생성 및 클라이언트 컴포넌트 구성
4. `YorkieProvider`/`DocumentProvider` 적용, `initialRoot` 빈 그래프 세팅
5. `FlowEditor`에 React Flow 배치, 이벤트 핸들러(`onNodesChange`/`onEdgesChange`/`onConnect`) 구현
6. **Add** 버튼으로 노드 추가 로직 구현(ID/위치 전략 포함)
7. 스타일/UX 다듬기, 로딩/에러 처리 보강
8. E2E 수동 검증(동시 편집), 필요시 문서키 해시 전략 옵션화

### 향후 개선

- 노드/엣지 컨텍스트 메뉴, 속성 패널
- 미니맵/줌 컨트롤, 스냅 투 그리드
- 퍼포먼스 최적화(메모화, 대규모 그래프 가상화)
- 접근성/키보드 단축키
